# Open3E Datapoint Definitions - TEST VERSION
# Community-maintained - edit directly

datapoints:
  268:  # FlowTemperatureSensor - Multi-Value Sensor
    type: "temperature_sensor"
    name: "Flow Temperature"
    subs:
      Actual: { suffix: "current" }
      Minimum: { suffix: "min" }
      Maximum: { suffix: "max" }
      Average: { suffix: "avg" }
      Unknown: { suffix: "unknown", enabled: false }

  269:  # ReturnTemperatureSensor
    type: "temperature_sensor"
    name: "Return Temperature"
    subs:
      Actual: { suffix: "current" }

  274:  # OutsideTemperatureSensor
    type: "temperature_sensor"
    name: "Outside Temperature"
    subs:
      Actual: { suffix: "current" }

  318:  # WaterPressureSensor
    type: "pressure_sensor"
    name: "Water Pressure"
    subs:
      Actual: { suffix: "current" }

  271:  # DomesticHotWaterSensor
    type: "temperature_sensor"
    name: "Hot Water"
    subs:
      Actual: { suffix: "" }

  # Mixer circuit flow temperatures (Actual only for dashboard)
  284:  # MixerOneCircuitFlowTemperatureSensor
    type: "temperature_sensor"
    name: "Circuit 1 Flow Temperature"
    subs:
      Actual: { suffix: "current" }

  286:  # MixerTwoCircuitFlowTemperatureSensor
    type: "temperature_sensor"
    name: "Circuit 2 Flow Temperature"
    subs:
      Actual: { suffix: "current" }

  # Heating buffer temperatures (if present)
  277:  # BufferBottomTemperatureSensor
    type: "temperature_sensor"
    name: "Buffer Temperature Bottom"
    subs:
      Actual: { suffix: "current" }
  279:  # BufferMidTemperatureSensor
    type: "temperature_sensor"
    name: "Buffer Temperature Middle"
    subs:
      Actual: { suffix: "current" }
  281:  # BufferTopTemperatureSensor
    type: "temperature_sensor"
    name: "Buffer Temperature Top"
    subs:
      Actual: { suffix: "current" }

  # Power and thermal capacity (for dashboards and COP calcs)
  2496:  # CurrentThermalCapacitySystem (W)
    type: "power_sensor"
    name: "Thermal Power (System)"

  1603:  # PointOfCommonCouplingPower
    type: "power_sensor"
    name: "Grid Active Power"
    subs:
      ActivePower: { suffix: "current" }

  # Electrical energy totals (counters)
  535:  # ObjectElectricalEnergyStatistical
    type: "energy_sensor"
    name: "Electrical Energy Statistics"
    subs:
      GridSuppliedEnergy: { }
      ProducedEnergy: { }
      GridFeedInEnergy: { }

  377:  # IdentNumber - for device identification
    type: "device_info"
    name: "Device Identification"
    extract_serial: true

  396:  # DomesticHotWaterTemperatureSetpoint - Writable Setpoint
    type: "temperature_setpoint"
    name: "DHW Setpoint"
    min: 10
    max: 65
    step: 0.5
    writable: true
    write_mode: "write"

  # Vitocal 250 - simple migrations from manual HA config
  2442:  # HeatPumpFrostProtection
    type: "binary_onoff"
    name: "Heat Pump Frost Protection"
    payload_off: "0.0"
    payload_on: "1.0"

  401:  # MixerOneCircuitPump (HK1 pump status)
    type: "binary_onoff"
    name: "Circuit 1 Pump"
    icon: "mdi:pump"
    payload_off: "0.0"
    payload_on: "1.0"

  2488:  # CurrentElectricalPowerConsumptionSystem
    type: "power_sensor"
    name: "Power Consumption (System)"

  1775:  # PrimaryCircuitFanOne (%)
    type: "pump_sensor"
    name: "Primary Circuit Fan 1"

  1776:  # PrimaryCircuitFanTwo (%)
    type: "pump_sensor"
    name: "Primary Circuit Fan 2"

  # Writable number (DID 2626)
  2626:  # MaximumPowerElectricalHeater (W)
    type: "power_sensor"
    name: "Max Power Electric Heater"
    writable: true
    min: 0
    max: 8000
    step: 100
    # SAFE-01: Values 1-3999W are DANGEROUS (Viessmann FW bug, Discussion #205)
    # Compressor failure and valve oscillation. Safe values: 0, >=4000W.
    command_template: >
      {% set intvalue = value | int %}
      {% if intvalue > 0 and intvalue < 4000 %}
      {% else %}
      {% set cmddata = '%02x' % (intvalue % 256) + '%02x' % (intvalue // 256) + '0000' %}
      {% set cmd = {'mode': 'write-raw', 'data': [[2626, cmddata]]} %}
      {{ cmd | to_json }}
      {% endif %}

  # Additional binary sensors
  2855:  # HK1 frost protection config
    type: "binary_onoff"
    name: "Circuit 1 Frost Protection"
    payload_off: "0.0"
    payload_on: "1.0"

  2856:  # HK2 frost protection config
    type: "binary_onoff"
    name: "Circuit 2 Frost Protection"
    payload_off: "0.0"
    payload_on: "1.0"

  402:  # MixerTwoCircuitPump (HK2 pump status)
    type: "binary_onoff"
    name: "Circuit 2 Pump"
    icon: "mdi:pump"
    payload_off: "0.0"
    payload_on: "1.0"

  2351:  # HeatPumpCompressor
    type: "binary_onoff"
    name: "Compressor Status"
    payload_off: "0.0"
    payload_on: "1.0"

  2352:  # AdditionalElectricHeater
    type: "binary_onoff"
    name: "Additional Heater Status"
    payload_off: "0000"
    payload_on: "0100"

  # Temperature sensors with /Actual
  1770:  # SecondaryOutletTemperatureSensor
    type: "temperature_sensor"
    name: "Secondary Circuit Supply Temperature"
    subs:
      Actual: { suffix: "current" }

  1771:  # EngineRoomTemperatureSensor
    type: "temperature_sensor"
    name: "Boiler Room Temperature"
    subs:
      Actual: { suffix: "current" }

  2333:  # EconomizerLiquidTemperatureSensor
    type: "temperature_sensor"
    name: "Condenser Liquid Temperature"
    subs:
      Actual: { suffix: "current" }

  2334:  # EvaporatorVaporTemperatureSensor
    type: "temperature_sensor"
    name: "Evaporator Vapor Temperature"
    subs:
      Actual: { suffix: "current" }

  # EMS Resulting Control State with mapping
  2350:  # EnergyManagmentSystemResultingControlState
    type: "generic_sensor"
    name: "Smart Grid Operating State"
    icon: "mdi:home-variant"
    value_template: >
      {% set ostate = int(value) %}
      {% if ostate==1 %}
        {{ "Shutdown" }}
      {% elif ostate==2 %}
        {{ "Normal operation" }}
      {% elif ostate==3 %}
        {{ "Preferred operation" }}
      {% elif ostate==4 %}
        {{ "Forced operation" }}
      {% else %}
        {{ value }}
      {% endif %}

  # LegionellaProtectionActivationTime - read-only, write-blacklisted (SAFE-03)
  875:  # LegionellaProtectionActivationTime
    type: "generic_sensor"
    name: "Legionella Protection Activation Time"
    icon: "mdi:shield-bug"

  # DomesticHotWaterOneTimeCharge - stateless Button
  1710:  # DomesticHotWaterOneTimeCharge
    type: "button_action"
    name: "DHW One-Time Charge"
    writable: true
    payload_press: "PRESS"
    command_template: >
      {% set cmd = {'mode': 'write', 'data': [[1710, 1]]} %}
      {{ cmd | to_json }}

  # QuickMode - Switch: on=1, off=0
  1006:  # QuickMode
    type: "switch_toggle"
    name: "Quick Mode"
    writable: true
    payload_on: "1"
    payload_off: "0"
    state_on: "1"
    state_off: "0"
    command_template: >
      {% set cmd = {'mode': 'write', 'data': [[1006, value]]} %}
      {{ cmd | to_json }}

  # Heating circuit 1 pump: Setpoint via 1102
  1102:  # MixerOneCircuitPumpMinimumMaximumLimit
    type: "pump_sensor"
    name: "Circuit 1 Pump"
    subs:
      Setpoint:
        entity_type: "number"
        writable: true
        min: 20
        max: 100
        step: 5
        unit_of_measurement: "%"
        icon: "mdi:pump"
        command_template: >
          {% set intvalue = value | int %}
          {% set cmddata = '14' + '%02x' % intvalue + '%02x' % intvalue %}
          {% set cmd = {'mode': 'write-raw', 'data': [[1102, cmddata]]} %}
          {{ cmd | to_json }}

  # Heating circuit 1 flow min/max via 1192
  1192:  # MixerOneCircuitFlowTemperatureMinimumMaximumLimit
    type: "temperature_setpoint"
    name: "Circuit 1 Flow Temperature"
    subs:
      Minimum:
        entity_type: "number"
        writable: true
        min: 10
        max: 60
        step: 1
        unit_of_measurement: "°C"
        icon: "mdi:thermometer"
        command_template: >
          {% set flowmax = min(max(states('sensor.1192_mixeronecircuitflowtemperature_maximum') | int * 10,100),600) %}
          {% set flowmin = min(max(value*10 | int, 100), flowmax) %}
          {% set cmddata = '%02x' % (flowmin % 256) + '%02x' % (flowmin // 256) + '%02x' % (flowmax % 256) + '%02x' % (flowmax // 256) + '000000000000' %}
          {% set cmd = {'mode': 'write-raw', 'data': [[1192, cmddata]]} %}
          {{ cmd | to_json }}

      Maximum:
        entity_type: "number"
        writable: true
        min: 10
        max: 60
        step: 1
        unit_of_measurement: "°C"
        icon: "mdi:thermometer"
        command_template: >
          {% set flowmin = min(max(states('sensor.1192_mixeronecircuitflowtemperature_minimum') | int * 10,100),600) %}
          {% set flowmax = min(max(value*10 | int, flowmin), 600) %}
          {% set cmddata = '%02x' % (flowmin % 256) + '%02x' % (flowmin // 256) + '%02x' % (flowmax % 256) + '%02x' % (flowmax // 256) + '000000000000' %}
          {% set cmd = {'mode': 'write-raw', 'data': [[1192, cmddata]]} %}
          {{ cmd | to_json }}

  # Heating circuit 2 pump: Setpoint via 1103
  1103:  # MixerTwoCircuitPumpMinimumMaximumLimit
    type: "pump_sensor"
    name: "Circuit 2 Pump"
    subs:
      Setpoint:
        entity_type: "number"
        writable: true
        min: 20
        max: 100
        step: 5
        unit_of_measurement: "%"
        icon: "mdi:pump"
        command_template: >
          {% set intvalue = value | int %}
          {% set cmddata = '1464' + '%02x' % intvalue %}
          {% set cmd = {'mode': 'write-raw', 'data': [[1103, cmddata]]} %}
          {{ cmd | to_json }}

  # --- Status DIDs (DATA-03 + DATA-05) ---

  2335:  # FourWayValve
    type: "generic_sensor"
    name: "Four-Way Valve"
    icon: "mdi:valve"
    value_template: >
      {% set state = value | int %}
      {% if state == 0 %}Heating
      {% elif state == 1 %}Defrost
      {% elif state == 2 %}DHW
      {% elif state == 3 %}Cooling
      {% else %}{{ value }}{% endif %}

  2346:  # CompressorSpeed (%)
    type: "pump_sensor"
    name: "Compressor Speed"

  2569:  # CompressorSpeedRPS
    type: "generic_sensor"
    name: "Compressor Speed (rps)"
    unit_of_measurement: "rps"
    state_class: "measurement"

  354:  # PrimaryHeatExchanger
    type: "temperature_sensor"
    name: "Primary Heat Exchanger Temperature"
    subs:
      Actual: { suffix: "current" }

  1690:  # PVStatus
    type: "generic_sensor"
    name: "PV Status"
    icon: "mdi:solar-power"

  1834:  # PVPowerGeneration
    type: "power_sensor"
    name: "PV Power Generation"
    icon: "mdi:solar-power"

  # Heating circuit 1/2 operation modes: off/auto as Select
  1415:  # MixerOneCircuitOperationState
    type: "select_mode"
    name: "Circuit 1 Operation Mode"
    subs:
      Mode/ID:
        entity_type: "select"
        options: ["off", "auto"]
        value_template: "{{ 'off' if (value | int(0)) == 0 else 'auto' }}"
        command_template: >
          {% set values = { 'auto':'0102', 'off':'0000'} %}
          {% set cmd = {'mode': 'write-raw', 'data':[[1415, values[value]]]} %}
          {{ cmd | to_json }}
    climate:
      name: "Heating Circuit 1"
      trigger_sub: "Mode/ID"
      modes: ["off", "auto"]
      mode_state_template: "{{ 'off' if (value_json | int(0)) == 0 else 'auto' }}"
      mode_command_template: >
        {% set values = { 'auto':'0102', 'off':'0000'} %}
        {% set cmd = {'mode': 'write-raw', 'data':[[1415, values[value]]]} %}
        {{ cmd | to_json }}
      temperature_did: 1643
      temperature_did_name: "MixerOneCircuitCurrentTemperatureSetpoint"
      min_temp: 3
      max_temp: 37
      precision: 1.0
      temperature_unit: "C"
      temperature_command_template: >
        {% set value_target = (value*10) | int %}
        {% set hk1_bp = states('sensor.1415_mixeronecircuitoperationstate') %}
        {% if (hk1_bp=="Komfort") %}
        {% set value_com = min(max(30, value_target),370) %}
        {% set value_sta = min(max(30, value_target-20),370) %}
        {% set value_red = min(max(30, value_target-40),370) %}
        {% elif (hk1_bp=="Reduziert") or (hk1_bp=="Frostschutz") or (hk1_bp=="Abschaltbetrieb") %}
        {% set value_com = min(max(30, value_target+40),370) %}
        {% set value_sta = min(max(30, value_target+20),370) %}
        {% set value_red = min(max(30, value_target),370) %}
        {% else %}
        {% set value_com = min(max(30, value_target+20),370) %}
        {% set value_sta = min(max(30, value_target),370) %}
        {% set value_red = min(max(30, value_target-20),370) %}
        {% endif %}
        {% set cmddata = '%02x' % (value_com % 256) + '%02x' % (value_com // 256) + '%02x' % (value_sta % 256) + '%02x' % (value_sta // 256) + '%02x' % (value_red % 256) + '%02x' % (value_red // 256) + '000000' %}
        {% set cmd = {'mode': 'write-raw', 'data':[[424, cmddata]]} %}
        {{ cmd | to_json }}

  1416:  # MixerTwoCircuitOperationState
    type: "select_mode"
    name: "Circuit 2 Operation Mode"
    subs:
      Mode/ID:
        entity_type: "select"
        options: ["off", "auto"]
        value_template: "{{ 'off' if (value | int(0)) == 0 else 'auto' }}"
        command_template: >
          {% set values = { 'auto':'0102', 'off':'0000'} %}
          {% set cmd = {'mode': 'write-raw', 'data':[[1416, values[value]]]} %}
          {{ cmd | to_json }}
    climate:
      name: "Heating Circuit 2"
      trigger_sub: "Mode/ID"
      modes: ["off", "auto"]
      mode_state_template: "{{ 'off' if (value_json | int(0)) == 0 else 'auto' }}"
      mode_command_template: >
        {% set values = { 'auto':'0102', 'off':'0000'} %}
        {% set cmd = {'mode': 'write-raw', 'data':[[1416, values[value]]]} %}
        {{ cmd | to_json }}
      temperature_did: 1644
      temperature_did_name: "MixerTwoCircuitCurrentTemperatureSetpoint"
      min_temp: 3
      max_temp: 37
      precision: 1.0
      temperature_unit: "C"
      temperature_command_template: >
        {% set value_target = (value*10) | int %}
        {% set hk2_bp = states('sensor.1416_mixertwocircuitoperationstate') %}
        {% if (hk2_bp=="Komfort") %}
        {% set value_com = min(max(30, value_target),370) %}
        {% set value_sta = min(max(30, value_target-20),370) %}
        {% set value_red = min(max(30, value_target-40),370) %}
        {% elif (hk2_bp=="Reduziert") or (hk2_bp=="Frostschutz") or (hk2_bp=="Abschaltbetrieb") %}
        {% set value_com = min(max(30, value_target+40),370) %}
        {% set value_sta = min(max(30, value_target+20),370) %}
        {% set value_red = min(max(30, value_target),370) %}
        {% else %}
        {% set value_com = min(max(30, value_target+20),370) %}
        {% set value_sta = min(max(30, value_target),370) %}
        {% set value_red = min(max(30, value_target-20),370) %}
        {% endif %}
        {% set cmddata = '%02x' % (value_com % 256) + '%02x' % (value_com // 256) + '%02x' % (value_sta % 256) + '%02x' % (value_sta // 256) + '%02x' % (value_red % 256) + '%02x' % (value_red // 256) + '000000' %}
        {% set cmd = {'mode': 'write-raw', 'data':[[426, cmddata]]} %}
        {{ cmd | to_json }}


# Device identification (priority: first found is used)
device_identification_dids:
  377:  # IdentNumber - often serial/model info
    type: "device_info"
    name: "Device Identification"
    extract_model: true
  256:  # DeviceProperty
    type: "device_info"
    name: "Device Property"

# Device mapping based on found strings
device_patterns:
  - pattern: "250"
    name: "Vitocal 250-A"
    model: "Vitocal 250-A"
  - pattern: "252"
    name: "Vitocal 252-A"
    model: "Vitocal 252-A"
  - pattern: "VX3"
    name: "Viessmann VX3"
    model: "VX3"
  - pattern: "VDENS"
    name: "Viessmann Vitodens"
    model: "Vitodens"

# Fallback if no device info found
default_device:
  name: "Open3E System"
  model: "E3 Controller"

# Write-blacklisted DIDs (read allowed, write blocked in discovery)
write_blacklisted_dids:
  - 875  # LegionellaProtectionActivationTime - safety-critical, read-only

# Faulty DIDs (ignored)
ignored_dids:
  - 540  # Device rejected read access
